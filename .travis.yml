language: python
sudo: false
env:
  global:
    - OFFICIAL_REPO="slaclab/lightpath"
    - secure: "tV+zuW0Wqt4pruoWfHAW3sNHSGXqPQjmhYf0qpxPvFyMFISP8tBxSnVlcPyQN0ILBdbkhTOXBUWuaRSYOBJdAleCPxcdR5A0dIjUsqVz7+0f2ec3ucDCi5Ge+xaZy6LzCI0ZJE0o/SvdOeSpLimj4+jKhEQUTqGphNNVXVct0R9sSP7wZopGlKs/6BQ3gbkdGGX7t5n0edUMrxZ9AfjA8eYcOQ8CIiKJ7viUGT7FG+bk8CyNrwcVy1r6Emh2gIPdgsCIspHsUrLYK4ll/lzrnkNR690Qqlo2HDcvlCpPUStJAtfMh8JDmZ/ECl8uT/A8O7x6PEE1+wfq4s6gO7e2xEgdscVnm3EgQE0/ixxf0ahX61BGZcNo2bWy5R027SeMGn0WEmvRL0jkHFrU4i7sglyiS/aFLIRg2zmq2zXovE7tmtBwxbKuA7K3RkpwOF3XDoRDh0sGGNf2XvzCVkdQds/ZSW4Ygw8PcQ7YwjEW9LQwponeFY/5Y1eZLFoz+i3UE7xbMFbfnmntXjvKCbpLZgbLC3u86jTMEx+F2LC/4RiGxGtNAI+igr+No5LdWiVo4ct2orloNvtXbB1xoBLG4T3z5fklhyN4wi6AjrapPqDP4dpNxMxw1pi6+yzBi1aHOi/trKJvTvfTqpXN9E3FPy68SjJCGDgyoK9SmJVJh4k="

matrix:
  include:
      - python: 3.5
      - python: 3.6
        env: BUILD_DOCS=1

install:
  - sudo apt-get update
  # We do this conditionally because it saves us some downloading if the
  # version is the same.
  - if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh;
    else
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda install conda-build anaconda-client
  - conda update -q conda conda-build
  # Useful for debugging any issues with conda
  - conda info -a
  #Grab all dependencies
  - conda create -q -n test-environment python=$TRAVIS_PYTHON_VERSION swig happi pyqt=5 coverage pip jinja2 wheel ophyd pytest prettytable -c skywalker-dev -c conda-forge -c lightsource2-tag
  #Launch Conda environment
  - source activate test-environment
  - pip install codecov
  - pip install -r requirements.txt --ignore-installed
  - pip install pyqtgraph
  #Install
  - python setup.py install
  - conda list # for DEBUG of QT issues
  - env

before_script:
    #Take from docs.travis-ci.com/user/gui-and-headless-browsers
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start

script:
  - coverage run run_tests.py
  - coverage report -m
  - set -e
  # Build docs.
  - |
    if [[ -n "$DOCTR_DEPLOY_ENCRYPTION_KEY" && $BUILD_DOCS ]]; then
      pip install -r docs-requirements.txt
      #Install doctr from a custom branch until
      #https://github.com/drdoctr/doctr/pull/190 is merged.
      pip uninstall -y doctr
      pip install git+https://github.com/danielballan/doctr@other-master 
      pushd docs
      make html
      popd
      # Publish docs.
      doctr deploy --deploy-repo lcls-pcds/skywalker-docs --deploy-branch-name master lightpath
    fi

after_success:
  - codecov
  - |
    if [[ $TRAVIS_PULL_REQUEST == false && $TRAVIS_REPO_SLUG == $OFFICIAL_REPO && $TRAVIS_BRANCH == $TRAVIS_TAG  && $TRAVIS_TAG != '' && $CONDA_UPLOAD_TOKEN_TAG != '' ]]; then
      conda build . -c defaults -c conda-forge -c skywalker-dev -c lightsource2-tag --token $CONDA_UPLOAD_TOKEN_TAG --python $TRAVIS_PYTHON_VERSION
    fi
  - |
    if [[ $TRAVIS_PULL_REQUEST == false && $TRAVIS_REPO_SLUG == $OFFICIAL_REPO && $TRAVIS_BRANCH == 'master' && $TRAVIS_TAG == '' && $CONDA_UPLOAD_TOKEN_DEV != '' ]]; then
      conda build . -c defaults -c conda-forge -c skywalker-dev -c lightsource2-tag --token $CONDA_UPLOAD_TOKEN_DEV --python $TRAVIS_PYTHON_VERSION
    fi
